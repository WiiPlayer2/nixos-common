{ templates
, cfg
, pkgs
, NixVirt
, _lib
, images
,
}:
let
  inherit (pkgs.lib)
    elemAt
    defaultTo
    ;
  presetCfg = cfg.domains.presets.pentest;
  base = templates.domain.linux {
    name = "pentest";
    uuid = "7e00e42e-4bc2-5cbe-b3db-2f7b01e13b02";
    memory = {
      count = presetCfg.config.memory;
      unit = "GiB";
    };
    storage_vol = images.pentest + "/nixos.qcow2";
    virtio_video = false;
  };
  mergedDefinition = base // {
    vcpu.count = presetCfg.config.cpus;
    devices = base.devices // {
      emulator = defaultTo base.devices.emulator presetCfg.config.qemu;
      disk = [
        (
          (elemAt base.devices.disk 0)
            // {
            readonly = true;
          }
        )
        (elemAt base.devices.disk 1)
      ];
      serial = {
        type = "pty";
        source = {
          path = "/dev/pts/1";
        };
        target = {
          type = "isa-serial";
          port = 0;
          model = {
            name = "isa-serial";
          };
        };
      };
    };
  };
in
NixVirt.lib.domain.writeXML mergedDefinition
